<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>代码编辑器</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/xml.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        background-color: #1e1e1e;
        color: #d4d4d4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        padding: 20px;
      }

      .editor-container {
        display: flex;
        width: 90%;
        max-width: 1000px;
        height: 80vh;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        background-color: #252526;
      }

      .line-numbers {
        width: 50px;
        background-color: #1e1e1e;
        padding: 10px 0;
        text-align: right;
        color: #858585;
        font-size: 14px;
        overflow-y: hidden;
        user-select: none;
      }

      .line-numbers div {
        padding: 0 10px;
        height: 20px;
        line-height: 20px;
      }

      .code-area {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .language-selector {
        background-color: #333333;
        padding: 8px;
        border-bottom: 1px solid #444;
      }

      select {
        background-color: #252526;
        color: #d4d4d4;
        border: 1px solid #444;
        padding: 5px;
        border-radius: 4px;
        outline: none;
      }

      .editor {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      #code-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        color: transparent;
        caret-color: white;
        border: none;
        outline: none;
        padding: 10px;
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 14px;
        resize: none;
        tab-size: 4;
        line-height: 20px;
        overflow-y: auto;
        white-space: pre;
        z-index: 2;
      }

      #code-display {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        padding: 10px;
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 14px;
        line-height: 20px;
        overflow: hidden;
        white-space: pre;
        z-index: 1;
      }

      .editor-wrapper {
        flex: 1;
        position: relative;
        overflow: auto;
      }

      .toolbar {
        background-color: #333333;
        padding: 8px;
        display: flex;
        gap: 10px;
        border-top: 1px solid #444;
      }

      button {
        background-color: #0e639c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #1177bb;
      }

      .wrap-toggle {
        display: flex;
        align-items: center;
        margin-left: auto;
        color: #d4d4d4;
        font-size: 12px;
      }

      .wrap-toggle input {
        margin-right: 5px;
      }

      /* 代码高亮样式 */
      pre {
        margin: 0;
        background: transparent !important;
      }

      code {
        font-family: "Menlo", "Monaco", "Courier New", monospace;
      }

      /* 修复高亮显示 */
      .hljs {
        background: transparent !important;
        padding: 0 !important;
      }
    </style>
  </head>
  <body>
    <div class="editor-container">
      <div class="line-numbers" id="line-numbers"></div>
      <div class="code-area">
        <div class="language-selector">
          <select id="language-select">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
            <option value="java">Java</option>
            <option value="html">HTML</option>
            <option value="css">CSS</option>
            <option value="plaintext">Plain Text</option>
          </select>
        </div>
        <div class="editor">
          <div class="editor-wrapper">
            <textarea id="code-input" spellcheck="false"></textarea>
            <div id="code-display"></div>
          </div>
        </div>
        <div class="toolbar">
          <button id="format-btn">格式化代码</button>
          <button id="copy-btn">复制代码</button>
          <div class="wrap-toggle">
            <input type="checkbox" id="wrap-toggle" />
            <label for="wrap-toggle">自动换行</label>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const codeInput = document.getElementById("code-input");
        const codeDisplay = document.getElementById("code-display");
        const lineNumbers = document.getElementById("line-numbers");
        const languageSelect = document.getElementById("language-select");
        const formatBtn = document.getElementById("format-btn");
        const copyBtn = document.getElementById("copy-btn");
        const wrapToggle = document.getElementById("wrap-toggle");
        const editorWrapper = document.querySelector(".editor-wrapper");

        // 初始化行号
        function updateLineNumbers() {
          const lines = codeInput.value.split("\n");
          lineNumbers.innerHTML = "";

          for (let i = 0; i < lines.length; i++) {
            const lineNumber = document.createElement("div");
            lineNumber.textContent = i + 1;
            lineNumbers.appendChild(lineNumber);
          }
        }

        // 初始化代码高亮
        function updateHighlight() {
          const code = codeInput.value;
          const language = languageSelect.value;

          // 使用highlight.js进行代码高亮
          // 转义HTML特殊字符以防止XSS
          const escapedCode = code
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");

          codeDisplay.innerHTML = `<pre><code class="hljs language-${language}">${escapedCode}</code></pre>`;
          hljs.highlightElement(codeDisplay.querySelector("code"));
        }

        // 同步滚动 - 修复滚动同步问题
        editorWrapper.addEventListener("scroll", function () {
          codeDisplay.style.top = -editorWrapper.scrollTop + "px";
          codeDisplay.style.left = -editorWrapper.scrollLeft + "px";
          lineNumbers.scrollTop = editorWrapper.scrollTop;
        });

        // 监听输入变化
        codeInput.addEventListener("input", function () {
          updateLineNumbers();
          updateHighlight();
        });

        // 监听语言变化
        languageSelect.addEventListener("change", updateHighlight);

        // 格式化代码
        formatBtn.addEventListener("click", function () {
          try {
            const language = languageSelect.value;
            let formattedCode = codeInput.value;

            // 简单的格式化逻辑，实际项目中可以使用专业的格式化库
            if (language === "javascript" || language === "java") {
              try {
                // 尝试使用JSON格式化（适用于JS对象）
                const parsed = JSON.parse(formattedCode);
                formattedCode = JSON.stringify(parsed, null, 2);
              } catch (e) {
                // 不是有效的JSON，保持原样
              }
            }

            codeInput.value = formattedCode;
            updateLineNumbers();
            updateHighlight();
          } catch (error) {
            alert("格式化失败: " + error.message);
          }
        });

        // 复制代码
        copyBtn.addEventListener("click", function () {
          codeInput.select();
          document.execCommand("copy");

          // 显示复制成功提示
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "复制成功!";
          setTimeout(() => {
            copyBtn.textContent = originalText;
          }, 1500);
        });

        // 自动换行切换
        wrapToggle.addEventListener("change", function () {
          if (this.checked) {
            codeInput.style.whiteSpace = "pre-wrap";
            codeDisplay.style.whiteSpace = "pre-wrap";
          } else {
            codeInput.style.whiteSpace = "pre";
            codeDisplay.style.whiteSpace = "pre";
          }
        });

        // 处理Tab键
        codeInput.addEventListener("keydown", function (e) {
          if (e.key === "Tab") {
            e.preventDefault();

            // 插入制表符（4个空格）
            const start = this.selectionStart;
            const end = this.selectionEnd;

            this.value =
              this.value.substring(0, start) +
              "    " +
              this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;

            updateLineNumbers();
            updateHighlight();
          }
        });

        // 初始化
        updateLineNumbers();
        updateHighlight();
      });
    </script>
  </body>
</html>
